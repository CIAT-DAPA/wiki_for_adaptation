{% extends "base.html" %}
{% load wagtailcore_tags %}

{% block content %}
  <article class="metric">
    <header class="page-header">
      <span class="badge badge-metric">Metric</span>
      <h1 class="page-title">{{ page.title }}</h1>
      <p class="page-meta">
        <i class="fas fa-user author-icon"></i> Dr. {{ page.entry_author|default:"Unknown" }} 
        <i class="fas fa-calendar date-icon"></i> {{ page.first_published_at|date:"m/d/Y" }}
      </p>
    </header>

    <section class="card">
      <h2>Description</h2>
      <div class="prose">{{ page.description|safe }}</div>
    </section>

    {% if page.purpose %}
    <section class="card">
      <h2><i class="fas fa-bullseye icon"></i> Purpose</h2>
      <div class="prose">{{ page.purpose|safe }}</div>
    </section>
    {% endif %}

    <section class="methods-section">
      <h2>Methods</h2>
      {% for child in page.get_children.specific %}
        {% if child.content_type.model == 'methodpage' %}
          <article id="method-{{ child.slug }}" class="method-block">
            <h3 class="method-title">{{ child.title }}</h3>
            {% if child.description %}
              <p class="method-description">{{ child.description|safe|striptags|truncatewords:50 }}</p>
            {% endif %}
            
            {% if child.resolution %}
            <div class="resolution-row">
              <i class="fas fa-expand-arrows-alt resolution-icon"></i>
              <strong>Resolution</strong>
              <span>{{ child.resolution }}</span>
            </div>
            {% endif %}

            <div class="advantages-limitations-grid">
              {% if child.advantages %}
              <div class="advantages-box">
                <h4><i class="fas fa-check-circle check-icon"></i> Advantages</h4>
                {{ child.advantages|safe }}
              </div>
              {% endif %}
              
              {% if child.limitations %}
              <div class="limitations-box">
                <h4><i class="fas fa-times-circle warning-icon"></i> Limitations</h4>
                {{ child.limitations|safe }}
              </div>
              {% endif %}
            </div>

            {% if child.use_case %}
            <div class="use-case-section">
              <h4>Use Case</h4>
              {{ child.use_case|safe }}
            </div>
            {% endif %}
          </article>
        {% endif %}
      {% endfor %}
    </section>

    <section class="card sop-section">
      <h2><i class="fas fa-clipboard-list icon"></i> Related SOPs</h2>
      <p class="section-subtitle">Standard Operating Procedures for collecting this metric</p>
      <ul class="sop-list">
      {% for child in page.get_children.specific %}
        {% if child.content_type.model == 'soppage' %}
        <li class="sop-card">
          <a href="{{ child.url }}" class="sop-card-link">
            <span class="badge badge-sop">SOP</span>
            <div class="sop-main">
              <p class="sop-title"><strong>{{ child.title }}</strong></p>
              {% if child.definition %}
                <p class="sop-description">{{ child.definition|safe|striptags|truncatechars:120 }}</p>
              {% endif %}
            </div>
            <i class="fas fa-arrow-right sop-arrow"></i>
          </a>
        </li>
        {% endif %}
      {% endfor %}
      </ul>
    </section>
  </article>
{% endblock %}
