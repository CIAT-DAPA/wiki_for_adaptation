{% extends "catalog/catalog_base.html" %}
{% load wagtailcore_tags %}

{% block sidebar_contents %}
  <li><a href="#description" class="text-gray-700 hover:text-brand-green">Description</a></li>
  {% if page.purpose %}
  <li><a href="#purpose" class="text-gray-700 hover:text-brand-green">Purpose</a></li>
  {% endif %}
  {% with methods=page.get_children.live.specific %}
    {% if methods %}
    <li><a href="#methods" class="text-gray-700 hover:text-brand-green">Methods</a></li>
    {% endif %}
  {% endwith %}
  {% with sops=page.get_children.live.specific %}
    {% if sops %}
    <li><a href="#sops" class="text-gray-700 hover:text-brand-green">SOPs</a></li>
    {% endif %}
  {% endwith %}
{% endblock %}

{% block article_content %}
    <header class="mb-6 pb-4 border-b-2 border-gray-200">
      <span class="inline-block bg-brand-green text-white text-xs font-bold uppercase px-3 py-1 rounded mb-2">Metric</span>
      <h1 class="text-4xl font-bold text-gray-900 mb-2">{{ page.title }}</h1>
      <p class="text-gray-500 text-sm flex items-center gap-4">
        <span><i class="fas fa-user text-gray-400 mr-1"></i> Dr. {{ page.entry_author|default:"Unknown" }}</span>
        <span><i class="fas fa-calendar text-gray-400 mr-1"></i> {{ page.first_published_at|date:"m/d/Y" }}</span>
      </p>
    </header>

    {% if page.description %}
    <section id="description" class="bg-white border border-gray-200 rounded-lg shadow-sm p-6 mb-4 scroll-mt-20">
      <h2 class="text-2xl font-semibold text-gray-900 mb-3">Description</h2>
      <div class="prose prose-sm max-w-none">{{ page.description|safe }}</div>
    </section>
    {% endif %}

    {% if page.purpose %}
    <section id="purpose" class="bg-white border border-gray-200 rounded-lg shadow-sm p-6 mb-4 scroll-mt-20">
      <h2 class="text-2xl font-semibold text-gray-900 mb-3 flex items-center">
        <i class="fas fa-bullseye text-gray-900 mr-2"></i>Purpose
      </h2>
      <div class="prose prose-sm max-w-none">{{ page.purpose|safe }}</div>
    </section>
    {% endif %}

    {% with methods=page.get_children.live.specific %}
      {% if methods %}
      <section id="methods" class="my-8 scroll-mt-20">
        <h2 class="text-3xl font-bold text-gray-900 mb-6">Methods</h2>
        <div class="space-y-6">
          {% for child in methods %}
            {% if child.content_type.model == 'methodpage' %}
            <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
              <h3 class="text-xl font-semibold text-gray-900 mb-3">{{ child.title }}</h3>
              
              {% if child.description %}
              <div class="mb-4 text-gray-700">
                {{ child.description|striptags|truncatewords:30 }}
              </div>
              {% endif %}

              {% if child.resolution %}
              <div class="mb-4">
                <h4 class="text-sm font-semibold text-gray-700 mb-2 flex items-center">
                  <i class="far fa-square text-gray-500 mr-2"></i>Resolution
                </h4>
                <div class="text-gray-700 text-sm">{{ child.resolution }}</div>
              </div>
              {% endif %}

              <div class="grid md:grid-cols-2 gap-6">
                {% if child.advantages %}
                <div>
                  <h4 class="text-sm font-semibold text-green-700 mb-2 flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>Advantages
                  </h4>
                  <div class="prose prose-sm max-w-none text-gray-700">{{ child.advantages|safe }}</div>
                </div>
                {% endif %}

                {% if child.limitations %}
                <div>
                  <h4 class="text-sm font-semibold text-red-700 mb-2 flex items-center">
                    <i class="fas fa-times-circle mr-2"></i>Limitations
                  </h4>
                  <div class="prose prose-sm max-w-none text-gray-700">{{ child.limitations|safe }}</div>
                </div>
                {% endif %}
              </div>
            </div>
            {% endif %}
          {% endfor %}
        </div>
      </section>
      {% endif %}
    {% endwith %}

    {% with sops=page.get_children.live.specific %}
      {% if sops %}
      <section id="sops" class="my-8 scroll-mt-20">
        <h2 class="text-3xl font-bold text-gray-900 mb-6">
          <i class="fas fa-clipboard-list text-gray-700 mr-2"></i>Standard Operating Procedures (SOPs)
        </h2>
        <div class="space-y-4">
          {% for child in sops %}
            {% if child.content_type.model == 'soppage' %}
            <a href="{% pageurl child %}" class="block bg-white border border-gray-200 rounded-lg shadow-sm p-5 hover:shadow-md hover:border-brand-orange transition-all group">
              <h3 class="text-lg font-semibold text-gray-900 group-hover:text-brand-orange transition-colors mb-2">
                {{ child.title }}
                <i class="fas fa-arrow-right ml-2 text-sm opacity-0 group-hover:opacity-100 transition-opacity"></i>
              </h3>
              {% if child.definition %}
              <p class="text-sm text-gray-600">{{ child.definition|striptags|truncatewords:20 }}</p>
              {% endif %}
            </a>
            {% endif %}
          {% endfor %}
        </div>
      </section>
      {% endif %}
    {% endwith %}
{% endblock %}
